[tools]
rust = "1.89.0"
python = "3.11.8"
hk = "1.36.0"
pkl = "0.30.2"
pitchfork = "1.5.0"

[tasks.py-setup]
run = "python3 -m pip install -r requirements.txt"

[tasks.rust-setup]
run = "rustup component add rustfmt clippy"

[tasks.fmt]
run = "cargo fmt --all -- --check"

[tasks.lint]
run = "cargo clippy --workspace --all-targets -- -D warnings"

[tasks.build]
run = "cargo build --workspace"

[tasks.test]
run = "cargo test --workspace"

[tasks.test-toy]
run = "python3 tools/toy/run_toy_vectors.py --fixtures tests/toy/fixtures"

[tasks.test-kcir-toy]
run = "python3 tools/kcir_toy/run_kcir_toy_vectors.py --fixtures tests/kcir_toy/fixtures"

[tasks.conformance-check]
run = "python3 tools/conformance/check_stub_invariance.py"

[tasks.doctrine-check]
run = "python3 tools/conformance/check_doctrine_site.py"

[tasks.conformance-run]
run = "python3 tools/conformance/run_capability_vectors.py"

[tasks.baseline]
run = [
  "mise run py-setup",
  "mise run rust-setup",
  "mise run fmt",
  "mise run lint",
  "mise run build",
  "mise run test",
  "mise run test-toy",
  "mise run test-kcir-toy",
  "mise run conformance-check",
  "mise run doctrine-check",
  "mise run ci-command-surface-check",
  "mise run ci-pipeline-check",
  "mise run ci-pipeline-test",
  "mise run ci-observation-test",
  "mise run ci-observation-check",
  "mise run ci-wiring-check",
  "mise run ci-instruction-check",
  "mise run ci-instruction-smoke",
  "mise run conformance-run",
]

[tasks.hk-install]
run = "HK_MISE=1 hk install --mise"

[tasks.hk-check]
run = "hk run check"

[tasks.hk-fix]
run = "hk run fix --all --no-stage"

[tasks.hk-pre-commit]
run = "hk run pre-commit"

[tasks.hk-pre-push]
run = "hk run pre-push"

[tasks.ci-project]
run = "python3 tools/ci/project_checks.py"

[tasks.ci-command-surface-check]
run = "python3 tools/ci/check_command_surface.py"

[tasks.ci-wiring-check]
run = "python3 tools/ci/check_ci_wiring.py"

[tasks.ci-pipeline-check]
run = "python3 tools/ci/check_pipeline_wiring.py"

[tasks.ci-pipeline-test]
run = [
  "python3 tools/ci/test_pipeline_required.py",
  "python3 tools/ci/test_pipeline_instruction.py",
  "python3 tools/ci/test_instruction_policy.py",
  "python3 tools/ci/test_instruction_reject_witness.py",
]

[tasks.ci-observation-build]
run = "python3 tools/ci/observation_surface.py build"

[tasks.ci-observation-query]
run = "python3 tools/ci/observation_surface.py query --mode latest"

[tasks.ci-observation-test]
run = "python3 tools/ci/test_observation_surface.py"

[tasks.ci-observation-serve]
run = "cargo run --package premath-cli -- observe-serve --surface artifacts/observation/latest.json --bind 127.0.0.1:43174"

[tasks.mcp-serve]
run = "cargo run --package premath-cli -- mcp-serve --issues .premath/issues.jsonl --issue-query-backend jsonl --mutation-policy instruction-linked --surface artifacts/observation/latest.json --repo-root ."

[tasks.ci-observation-check]
run = [
  "mise run ci-observation-build",
  "python3 tools/ci/check_observation_semantics.py",
]

[tasks.ci-pipeline-required]
run = "python3 tools/ci/pipeline_required.py"

[tasks.ci-pipeline-instruction]
run = "python3 tools/ci/pipeline_instruction.py --instruction ${INSTRUCTION:?set INSTRUCTION=instructions/<ts>-<id>.json}"

[tasks.ci-required]
run = "python3 tools/ci/run_required_checks.py"

[tasks.ci-verify-required]
run = "python3 tools/ci/verify_required_witness.py"

[tasks.ci-verify-required-strict]
run = "python3 tools/ci/verify_required_witness.py --compare-delta"

[tasks.ci-verify-required-strict-native]
run = "python3 tools/ci/verify_required_witness.py --compare-delta --require-native-check baseline"

[tasks.ci-decide-required]
run = "python3 tools/ci/decide_required.py --compare-delta --out artifacts/ciwitness/latest-decision.json"

[tasks.ci-verify-decision]
run = "python3 tools/ci/verify_decision.py"

[tasks.ci-required-verified]
run = [
  "mise run ci-required",
  "mise run ci-verify-required",
]

[tasks.ci-required-attested]
run = [
  "mise run ci-required",
  "mise run ci-verify-required-strict",
  "mise run ci-decide-required",
  "mise run ci-verify-decision",
]

[tasks.precommit]
run = "mise run ci-required-attested"

[tasks.ci-check]
run = "sh tools/ci/run_gate.sh hk-check"

[tasks.ci-pre-commit]
run = "sh tools/ci/run_gate.sh hk-pre-commit"

[tasks.ci-instruction]
run = "sh tools/ci/run_instruction.sh ${INSTRUCTION:?set INSTRUCTION=instructions/<ts>-<id>.json}"

[tasks.ci-instruction-check]
run = "sh -lc 'if [ -n \"${INSTRUCTION:-}\" ]; then python3 tools/ci/check_instruction_envelope.py \"$INSTRUCTION\"; else python3 tools/ci/check_instruction_envelope.py; fi'"

[tasks.ci-instruction-smoke]
run = "python3 tools/ci/test_instruction_smoke.py --instruction tests/ci/fixtures/instructions/20260221T010000Z-ci-wiring-golden.json"

[tasks.ci-instruction-example]
run = "sh tools/ci/run_instruction.sh instructions/20260221T000000Z-bootstrap-gate.json"

[tasks.infra-up]
run = "sh tools/infra/terraform/up.sh"

[tasks.infra-down]
run = "sh tools/infra/terraform/down.sh"

[tasks.ci-check-tf]
run = "sh tools/ci/run_gate_terraform.sh ci-required-attested"

[tasks.ci-pre-commit-tf]
run = "sh tools/ci/run_gate_terraform.sh hk-pre-commit"

[tasks.ci-check-tf-local]
run = "TF_VAR_cheese_profile=local sh tools/ci/run_gate_terraform.sh ci-required-attested"

[tasks.ci-check-tf-microvm]
run = "TF_VAR_cheese_profile=darwin_microvm_vfkit sh tools/ci/run_gate_terraform.sh ci-required-attested"

[tasks.jj-alias-install]
run = "sh tools/jj/install_aliases.sh"

[tasks.pf-start]
run = "pitchfork start docs-preview observation-api"

[tasks.pf-stop]
run = "sh -lc 'if pitchfork supervisor status >/dev/null 2>&1; then pitchfork stop --all; else echo \"pitchfork supervisor not running\"; fi'"

[tasks.pf-status]
run = "pitchfork list"

[tasks.pf-gate-loop-start]
run = "pitchfork start gate-check-loop"

[tasks.pf-gate-loop-stop]
run = "pitchfork stop gate-check-loop"
