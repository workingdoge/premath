[tools]
rust = "1.89.0"
python = "3.11.8"
hk = "1.36.0"
pkl = "0.30.2"
pitchfork = "1.5.0"

[tasks.py-setup]
run = "python3 -m pip install -r requirements.txt"

[tasks.rust-setup]
run = "rustup component add rustfmt clippy"

[tasks.fmt]
run = "cargo fmt --all -- --check"

[tasks.lint]
run = "cargo clippy --workspace --all-targets -- -D warnings"

[tasks.build]
run = "cargo build --workspace"

[tasks.test]
run = "cargo test --workspace"

[tasks.test-toy]
run = "python3 tools/toy/run_toy_vectors.py --fixtures tests/toy/fixtures"

[tasks.test-kcir-toy]
run = "python3 tools/kcir_toy/run_kcir_toy_vectors.py --fixtures tests/kcir_toy/fixtures"

[tasks.conformance-check]
run = "cargo run --package premath-cli -- capability-stub-invariance-check --fixtures tests/conformance/fixtures/capabilities --json"

[tasks.traceability-check]
run = "cargo run --package premath-cli -- spec-traceability-check --json"

[tasks.docs-coherence-check]
run = "python3 tools/conformance/check_docs_coherence.py"

[tasks.ci-drift-budget-check]
run = "cargo run --package premath-cli -- drift-budget-check --repo-root . --json"

[tasks.coherence-check]
run = "cargo run --package premath-cli -- coherence-check --contract specs/premath/draft/COHERENCE-CONTRACT.json --repo-root . --json"

[tasks.doctrine-check]
run = [
  "python3 tools/conformance/check_doctrine_site.py",
  "cargo run --package premath-cli -- runtime-orchestration-check --control-plane-contract specs/premath/draft/CONTROL-PLANE-CONTRACT.json --doctrine-op-registry specs/premath/draft/DOCTRINE-OP-REGISTRY.json --harness-runtime specs/premath/draft/HARNESS-RUNTIME.md --doctrine-site-input specs/premath/draft/DOCTRINE-SITE-INPUT.json --json",
  "cargo run --package premath-cli -- doctrine-mcp-parity-check --mcp-source crates/premath-cli/src/commands/mcp_serve.rs --registry specs/premath/draft/DOCTRINE-OP-REGISTRY.json --json",
  "python3 tools/conformance/run_fixture_suites.py --suite doctrine-inf",
]

[tasks.doctrine-site-inventory-check]
run = "python3 tools/conformance/generate_doctrine_site_inventory.py --check"

[tasks.conformance-run]
run = "python3 tools/conformance/run_fixture_suites.py"

[tasks.baseline]
run = [
  "mise run py-setup",
  "mise run rust-setup",
  "mise run fmt",
  "mise run lint",
  "mise run build",
  "mise run test",
  "mise run test-toy",
  "mise run test-kcir-toy",
  "mise run conformance-check",
  "mise run traceability-check",
  "mise run coherence-check",
  "mise run docs-coherence-check",
  "mise run ci-drift-budget-check",
  "mise run doctrine-check",
  "mise run ci-command-surface-check",
  "mise run ci-hygiene-check",
  "mise run ci-branch-policy-check",
  "mise run ci-pipeline-check",
  "mise run ci-pipeline-test",
  "mise run ci-observation-test",
  "mise run ci-observation-check",
  "mise run ci-wiring-check",
  "mise run ci-instruction-check",
  "mise run ci-instruction-smoke",
  "mise run conformance-run",
]

[tasks.hk-install]
run = "HK_MISE=1 hk install --mise"

[tasks.hk-check]
run = "hk run check"

[tasks.hk-fix]
run = "hk run fix --all --no-stage"

[tasks.hk-pre-commit]
run = "hk run pre-commit"

[tasks.hk-pre-push]
run = "hk run pre-push"

[tasks.ci-project]
run = "python3 tools/ci/project_checks.py"

[tasks.ci-command-surface-check]
run = "cargo run --package premath-cli -- command-surface-check --repo-root ."

[tasks.ci-hygiene-check]
run = [
  "cargo run --package premath-cli -- repo-hygiene-check --repo-root .",
  "cargo run --package premath-cli -- issue-graph-compact --repo-root . --issues .premath/issues.jsonl --mode check",
  "cargo run --package premath-cli -- issue-graph-check --repo-root . --issues .premath/issues.jsonl --note-warn-threshold 2000",
]

[tasks.ci-issue-compact-check]
run = "cargo run --package premath-cli -- issue-graph-compact --repo-root . --issues .premath/issues.jsonl --mode check"

[tasks.ci-issue-compact-apply]
run = "cargo run --package premath-cli -- issue-graph-compact --repo-root . --issues .premath/issues.jsonl --mode apply"

[tasks.ci-branch-policy-check]
run = "cargo run --package premath-cli -- branch-policy-check --policy specs/process/GITHUB-BRANCH-POLICY.json --rules-json tests/ci/fixtures/branch-policy/effective-main-rules-golden.json --json"

[tasks.ci-branch-policy-check-live]
run = "cargo run --package premath-cli -- branch-policy-check --policy specs/process/GITHUB-BRANCH-POLICY.json --fetch-live --json"

[tasks.ci-wiring-check]
run = "cargo run --package premath-cli -- ci-wiring-check --repo-root ."

[tasks.ci-pipeline-check]
run = "cargo run --package premath-cli -- pipeline-wiring-check --repo-root . --control-plane-contract specs/premath/draft/CONTROL-PLANE-CONTRACT.json"

[tasks.ci-pipeline-test]
run = [
  "python3 tools/ci/test_pipeline_required.py",
  "python3 tools/ci/test_run_required_checks.py",
  "python3 tools/ci/test_required_witness_lineage.py",
  "python3 tools/ci/test_required_delta_client.py",
  "python3 tools/ci/test_required_projection_client.py",
  "python3 tools/ci/test_required_witness_client.py",
  "python3 tools/ci/test_required_gate_ref_client.py",
  "python3 tools/ci/test_required_witness_verify_client.py",
  "python3 tools/ci/test_required_witness_decide_client.py",
  "python3 tools/ci/test_required_decision_verify_client.py",
  "python3 tools/ci/test_harness_retry_policy.py",
  "python3 tools/ci/test_harness_escalation.py",
  "python3 tools/ci/test_harness_multithread_loop.py",
  "python3 tools/ci/test_pipeline_wiring.py",
  "python3 tools/ci/test_pipeline_instruction.py",
  "python3 tools/ci/test_instruction_envelope_check.py",
  "python3 tools/ci/test_instruction_proposal.py",
  "python3 tools/ci/test_kcir_mapping_gate.py",
  "python3 tools/ci/test_control_plane_contract.py",
  "cargo test --package premath-cli drift_budget_check_json_smoke",
  "python3 tools/ci/test_instruction_check_client.py",
  "python3 tools/ci/test_proposal_check_client.py",
  "python3 tools/ci/test_client_transport_parity.py",
  "python3 tools/ci/test_instruction_reject_witness.py",
  "cargo test --package premath-cli branch_policy_check_json_smoke",
  "python3 tools/ci/test_repo_hygiene.py",
  "python3 tools/ci/test_issue_graph.py",
  "python3 tools/conformance/test_docs_coherence.py",
  "python3 tools/conformance/test_run_fixture_suites.py",
  "python3 tools/conformance/test_doctrine_site_contract.py",
  "cargo test --package premath-cli doctrine_mcp_parity_check_json_smoke",
  "cargo test --package premath-cli capability_stub_invariance_check_json_smoke",
  "python3 tools/conformance/test_runtime_orchestration.py",
  "python3 tools/conformance/test_world_core_vectors.py",
  "python3 tools/conformance/test_frontend_parity_vectors.py",
]

[tasks.ci-observation-build]
run = "cargo run --package premath-cli -- observe-build --repo-root ."

[tasks.ci-observation-query]
run = "cargo run --package premath-cli -- observe --surface artifacts/observation/latest.json --mode latest --json"

[tasks.ci-observation-test]
run = "python3 tools/ci/test_observation_surface.py"

[tasks.ci-observation-serve]
run = "cargo run --package premath-cli -- observe-serve --surface artifacts/observation/latest.json --bind 127.0.0.1:43174"

[tasks.mcp-serve]
run = "cargo run --package premath-cli -- mcp-serve --issues .premath/issues.jsonl --issue-query-backend jsonl --mutation-policy instruction-linked --surface artifacts/observation/latest.json --repo-root ."

[tasks.mcp-serve-status]
run = "python3 tools/ops/mcp_serve_lifecycle.py status"

[tasks.mcp-serve-stop]
run = "python3 tools/ops/mcp_serve_lifecycle.py stop"

[tasks.mcp-serve-restart]
run = [
  "mise run mcp-serve-stop",
  "mise run mcp-serve",
]

[tasks.harness-worker-loop]
run = "python3 tools/harness/multithread_loop.py worker"

[tasks.harness-coordinator-loop]
run = "python3 tools/harness/multithread_loop.py coordinator"

[tasks.harness-kpi-report]
run = "python3 tools/harness/benchmark_kpi.py --json"

[tasks.ci-observation-check]
run = [
  "mise run ci-observation-build",
  "cargo run --package premath-cli -- observation-semantics-check --repo-root . --ciwitness-dir artifacts/ciwitness --surface artifacts/observation/latest.json --issues-path .premath/issues.jsonl",
]

[tasks.ci-pipeline-required]
run = "python3 tools/ci/pipeline_required.py"

[tasks.ci-pipeline-instruction]
run = "python3 tools/ci/pipeline_instruction.py --instruction ${INSTRUCTION:?set INSTRUCTION=instructions/<ts>-<id>.json}"

[tasks.ci-required]
run = "python3 tools/ci/run_required_checks.py"

[tasks.ci-verify-required]
run = "python3 tools/ci/verify_required_witness.py"

[tasks.ci-verify-required-strict]
run = "python3 tools/ci/verify_required_witness.py --compare-delta"

[tasks.ci-verify-required-strict-native]
run = "python3 tools/ci/verify_required_witness.py --compare-delta --require-native-check baseline"

[tasks.ci-decide-required]
run = "python3 tools/ci/decide_required.py --compare-delta --out artifacts/ciwitness/latest-decision.json"

[tasks.ci-verify-decision]
run = "python3 tools/ci/verify_decision.py"

[tasks.ci-required-verified]
run = [
  "mise run ci-required",
  "mise run ci-verify-required",
]

[tasks.ci-required-attested]
run = [
  "mise run ci-required",
  "mise run ci-verify-required-strict",
  "mise run ci-decide-required",
  "mise run ci-verify-decision",
]

[tasks.precommit]
run = "mise run ci-required-attested"

[tasks.ci-check]
run = "sh tools/ci/run_gate.sh hk-check"

[tasks.ci-pre-commit]
run = "sh tools/ci/run_gate.sh hk-pre-commit"

[tasks.ci-instruction]
run = "sh tools/ci/run_instruction.sh ${INSTRUCTION:?set INSTRUCTION=instructions/<ts>-<id>.json}"

[tasks.ci-instruction-check]
run = "cargo run --package premath-cli -- instruction-batch-check --repo-root ."

[tasks.ci-instruction-smoke]
run = "python3 tools/ci/test_instruction_smoke.py --instruction tests/ci/fixtures/instructions/20260221T010000Z-ci-wiring-golden.json"

[tasks.ci-instruction-example]
run = "sh tools/ci/run_instruction.sh instructions/20260221T000000Z-bootstrap-gate.json"

[tasks.infra-up]
run = "sh tools/infra/terraform/up.sh"

[tasks.infra-down]
run = "sh tools/infra/terraform/down.sh"

[tasks.ci-check-tf]
run = "sh tools/ci/run_gate_terraform.sh ci-required-attested"

[tasks.ci-pre-commit-tf]
run = "sh tools/ci/run_gate_terraform.sh hk-pre-commit"

[tasks.ci-check-tf-local]
run = "TF_VAR_cheese_profile=local sh tools/ci/run_gate_terraform.sh ci-required-attested"

[tasks.ci-check-tf-microvm]
run = "TF_VAR_cheese_profile=darwin_microvm_vfkit sh tools/ci/run_gate_terraform.sh ci-required-attested"

[tasks.jj-alias-install]
run = "sh tools/jj/install_aliases.sh"

[tasks.pf-start]
run = "pitchfork start docs-preview observation-api"

[tasks.pf-stop]
run = "sh -lc 'if pitchfork supervisor status >/dev/null 2>&1; then pitchfork stop --all; else echo \"pitchfork supervisor not running\"; fi'"

[tasks.pf-status]
run = "pitchfork list"

[tasks.pf-gate-loop-start]
run = "pitchfork start gate-check-loop"

[tasks.pf-gate-loop-stop]
run = "pitchfork stop gate-check-loop"
