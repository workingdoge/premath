name: instruction

on:
  workflow_dispatch:
    inputs:
      instruction_path:
        description: "Instruction envelope path"
        required: true
        default: "instructions/20260221T000000Z-bootstrap-gate.json"
        type: string
      allow_failure:
        description: "Allow instruction check failure but still emit witness"
        required: true
        default: false
        type: boolean

jobs:
  instruction:
    name: ci-instruction
    runs-on: ubuntu-latest
    env:
      INSTRUCTION_PATH: ${{ inputs.instruction_path }}
      ALLOW_FAILURE: ${{ inputs.allow_failure }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup mise
        uses: jdx/mise-action@6d1e696aa24c1aa1bcc1adea0212707c71ab78a8 # v3.6.1
        with:
          version: 2026.2.17
          install: false

      - name: Trust and install pinned tools
        run: |
          mise trust
          mise install

      - name: Resolve instruction artifact path
        id: resolve
        run: |
          instruction_file="$(basename "$INSTRUCTION_PATH")"
          instruction_id="${instruction_file%.json}"
          echo "instruction_id=$instruction_id" >> "$GITHUB_OUTPUT"
          echo "instruction_file=$instruction_file" >> "$GITHUB_OUTPUT"

      - name: Run provider-neutral instruction pipeline
        run: python3 tools/ci/pipeline_instruction.py --instruction "$INSTRUCTION_PATH"

      - name: Upload instruction witness artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-instruction-witness
          path: |
            artifacts/ciwitness/${{ steps.resolve.outputs.instruction_id }}.json
            artifacts/ciwitness/${{ steps.resolve.outputs.instruction_id }}.sha256
          if-no-files-found: warn
