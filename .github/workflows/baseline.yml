name: baseline

on:
  pull_request:
  push:
    branches:
      - main
      - master

jobs:
  baseline:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup mise
        uses: jdx/mise-action@6d1e696aa24c1aa1bcc1adea0212707c71ab78a8 # v3.6.1
        with:
          version: 2026.2.17
          install: false

      - name: Trust and install pinned tools
        run: |
          mise trust
          mise install

      - name: Run required gate from change projection
        run: mise run ci-required

      - name: Verify required gate witness (strict delta compare)
        run: mise run ci-verify-required-strict

      - name: Decide required gate acceptance
        run: mise run ci-decide-required

      - name: Publish CI witness summary
        if: always()
        run: |
          python3 - <<'PY'
          import hashlib
          import json
          import os
          from pathlib import Path

          summary_path = Path(os.environ["GITHUB_STEP_SUMMARY"])
          witness_path = Path("artifacts/ciwitness/latest-required.json")
          digest_path = Path("artifacts/ciwitness/latest-required.sha256")
          decision_path = Path("artifacts/ciwitness/latest-decision.json")
          decision_digest_path = Path("artifacts/ciwitness/latest-decision.sha256")

          summary_lines = ["### CI Required Attestation"]

          if not witness_path.exists():
              summary_lines.append("")
              summary_lines.append("- witness: missing (`artifacts/ciwitness/latest-required.json`)")
          else:
              payload = json.loads(witness_path.read_text(encoding="utf-8"))
              raw_digest = hashlib.sha256(witness_path.read_bytes()).hexdigest()
              digest_path.write_text(raw_digest + "\n", encoding="utf-8")

              projection = payload.get("projectionDigest", "(missing)")
              verdict = payload.get("verdictClass", "(missing)")
              checks = payload.get("requiredChecks", [])
              checks_line = ", ".join(checks) if isinstance(checks, list) and checks else "(none)"

              summary_lines.extend(
                  [
                      "",
                      f"- projection digest: `{projection}`",
                      f"- witness verdict: `{verdict}`",
                      f"- required checks: `{checks_line}`",
                      f"- witness sha256: `{raw_digest}`",
                  ]
              )

          if not decision_path.exists():
              summary_lines.append("- decision: missing (`artifacts/ciwitness/latest-decision.json`)")
          else:
              decision = json.loads(decision_path.read_text(encoding="utf-8"))
              decision_digest = hashlib.sha256(decision_path.read_bytes()).hexdigest()
              decision_digest_path.write_text(decision_digest + "\n", encoding="utf-8")
              summary_lines.extend(
                  [
                      f"- decision: `{decision.get('decision', '(missing)')}`",
                      f"- decision reason: `{decision.get('reasonClass', '(missing)')}`",
                      f"- decision sha256: `{decision_digest}`",
                  ]
              )

          summary_path.write_text("\n".join(summary_lines) + "\n", encoding="utf-8")
          PY

      - name: Upload CI witness artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-required-witness
          path: |
            artifacts/ciwitness/latest-required.json
            artifacts/ciwitness/latest-required.sha256
            artifacts/ciwitness/latest-decision.json
            artifacts/ciwitness/latest-decision.sha256
            artifacts/ciwitness/proj1_*.json
          if-no-files-found: warn
